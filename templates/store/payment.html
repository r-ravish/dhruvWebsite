{% extends 'base.html' %}
{% load static %}

{% block title %}Complete Payment - Order #{{ order.id }} - ShopVerse{% endblock %}

{% block content %}
<section class="payment-section">
    <div class="container">
        <div class="payment-wrapper">
            <!-- Progress Steps -->
            <div class="checkout-steps">
                <div class="step completed">
                    <span class="step-number">✓</span>
                    <span class="step-text">Address</span>
                </div>
                <div class="step-line completed"></div>
                <div class="step active">
                    <span class="step-number">2</span>
                    <span class="step-text">Payment</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-text">Confirmation</span>
                </div>
            </div>

            <div class="payment-layout">
                <!-- Payment QR Section -->
                <div class="payment-qr-section">
                    <h2>Scan & Pay via UPI</h2>
                    
                    <div class="payment-amount-box">
                        <span class="label">Amount to Pay</span>
                        <span class="amount">₹{{ order.get_total }}</span>
                    </div>

                    <div class="qr-container">
                        <!-- QR Code using Google Charts API -->
                        <img src="https://chart.googleapis.com/chart?chs=250x250&cht=qr&chl=upi://pay?pa={{ upi_id }}&pn={{ upi_name|urlencode }}&am={{ order.get_total }}&cu=INR&tn=Order%20{{ order.id }}" 
                             alt="UPI QR Code" class="qr-code">
                        <p class="qr-hint">Scan with any UPI app</p>
                    </div>

                    <div class="upi-apps">
                        <span>Pay using:</span>
                        <div class="app-icons">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/UPI-Logo-vector.svg/120px-UPI-Logo-vector.svg.png" alt="UPI" title="Any UPI App">
                        </div>
                    </div>

                    <div class="upi-id-display">
                        <span class="label">Or pay directly to UPI ID:</span>
                        <div class="upi-id-box">
                            <span class="upi-id">{{ upi_id }}</span>
                            <button type="button" class="copy-btn" onclick="copyUPI()">Copy</button>
                        </div>
                    </div>

                    <div class="payment-instructions">
                        <h4>How to Pay:</h4>
                        <ol>
                            <li>Open any UPI app (GPay, PhonePe, Paytm, etc.)</li>
                            <li>Scan the QR code or enter the UPI ID</li>
                            <li>Enter amount: <strong>₹{{ order.get_total }}</strong></li>
                            <li>Complete the payment</li>
                            <li>Copy the Transaction ID/UTR from your app</li>
                            <li>Paste it below and submit</li>
                        </ol>
                    </div>
                </div>

                <!-- Transaction ID Form -->
                <div class="transaction-section">
                    <div class="order-summary-mini">
                        <h3>Order Summary</h3>
                        <div class="summary-items">
                            {% for item in order.items.all %}
                                <div class="summary-item">
                                    <span>{{ item.product.name }} × {{ item.quantity }}</span>
                                    <span>₹{{ item.get_subtotal }}</span>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="summary-total">
                            <span>Total:</span>
                            <span>₹{{ order.get_total }}</span>
                        </div>
                    </div>

                    <div class="transaction-form-section">
                        <h3>Enter Transaction Details</h3>
                        <p class="form-hint">After completing payment, enter your UPI Transaction ID or UTR number below:</p>
                        
                        <form method="post" class="transaction-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="id_transaction_id">Transaction ID / UTR Number *</label>
                                {{ form.transaction_id }}
                                <small class="help-text">You can find this in your UPI app payment history</small>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary btn-large">
                                    Submit & Confirm Order
                                </button>
                            </div>
                        </form>

                        <div class="payment-note">
                            <p><strong>Note:</strong> Your order will be processed once we verify your payment. This usually takes 5-10 minutes.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.payment-section {
    padding: 40px 0;
    background: #f5f5f6;
    min-height: calc(100vh - 200px);
}

.payment-wrapper {
    max-width: 1100px;
    margin: 0 auto;
}

.checkout-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 40px;
    padding: 20px;
    background: white;
    border-radius: 8px;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.step-number {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #666;
}

.step.active .step-number {
    background: #ff3f6c;
    color: white;
}

.step.completed .step-number {
    background: #14958f;
    color: white;
}

.step-text {
    font-size: 13px;
    color: #666;
}

.step.active .step-text,
.step.completed .step-text {
    color: #282c3f;
    font-weight: 500;
}

.step-line {
    width: 100px;
    height: 2px;
    background: #e0e0e0;
    margin: 0 10px;
}

.step-line.completed {
    background: #14958f;
}

.payment-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
}

.payment-qr-section,
.transaction-section {
    background: white;
    border-radius: 8px;
    padding: 30px;
}

.payment-qr-section h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #282c3f;
}

.payment-amount-box {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #ff3f6c 0%, #ff6b8a 100%);
    border-radius: 8px;
    color: white;
    margin-bottom: 25px;
}

.payment-amount-box .label {
    display: block;
    font-size: 14px;
    opacity: 0.9;
}

.payment-amount-box .amount {
    display: block;
    font-size: 36px;
    font-weight: 700;
    margin-top: 5px;
}

.qr-container {
    text-align: center;
    padding: 20px;
    background: #f8f8f8;
    border-radius: 8px;
    margin-bottom: 20px;
}

.qr-code {
    width: 200px;
    height: 200px;
    border: 4px solid white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.qr-hint {
    margin-top: 10px;
    color: #666;
    font-size: 14px;
}

.upi-apps {
    text-align: center;
    margin-bottom: 20px;
    color: #666;
    font-size: 14px;
}

.app-icons {
    margin-top: 10px;
}

.app-icons img {
    height: 30px;
}

.upi-id-display {
    background: #f0f8ff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.upi-id-display .label {
    display: block;
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
}

.upi-id-box {
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
    padding: 10px 15px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.upi-id {
    flex: 1;
    font-family: monospace;
    font-size: 16px;
    font-weight: 500;
    color: #282c3f;
}

.copy-btn {
    background: #ff3f6c;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.copy-btn:hover {
    background: #e9375f;
}

.payment-instructions {
    background: #fff8e6;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #f5a623;
}

.payment-instructions h4 {
    margin-bottom: 10px;
    color: #282c3f;
}

.payment-instructions ol {
    margin: 0;
    padding-left: 20px;
    color: #666;
    font-size: 14px;
}

.payment-instructions li {
    margin-bottom: 5px;
}

.order-summary-mini {
    background: #f8f8f8;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
}

.order-summary-mini h3 {
    margin-bottom: 15px;
    color: #282c3f;
}

.summary-items {
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 15px;
    margin-bottom: 15px;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 14px;
    color: #666;
}

.summary-total {
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    font-weight: 600;
    color: #282c3f;
}

.transaction-form-section h3 {
    margin-bottom: 10px;
    color: #282c3f;
}

.form-hint {
    color: #666;
    font-size: 14px;
    margin-bottom: 20px;
}

.transaction-form .form-group {
    margin-bottom: 20px;
}

.transaction-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #282c3f;
}

.transaction-form .form-input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #d4d5d9;
    border-radius: 4px;
    font-size: 16px;
}

.transaction-form .form-input:focus {
    border-color: #ff3f6c;
    outline: none;
}

.help-text {
    display: block;
    margin-top: 6px;
    color: #94969f;
    font-size: 12px;
}

.form-actions {
    margin-top: 25px;
}

.form-actions .btn {
    width: 100%;
    padding: 16px;
    font-size: 16px;
}

.payment-note {
    margin-top: 20px;
    padding: 15px;
    background: #e8f5e9;
    border-radius: 8px;
    font-size: 13px;
    color: #2e7d32;
}

@media (max-width: 768px) {
    .payment-layout {
        grid-template-columns: 1fr;
    }
    
    .checkout-steps {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .step-line {
        width: 40px;
    }
}
</style>

<script>
function copyUPI() {
    const upiId = '{{ upi_id }}';
    navigator.clipboard.writeText(upiId).then(function() {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = 'Copy';
        }, 2000);
    });
}
</script>
{% endblock %}
